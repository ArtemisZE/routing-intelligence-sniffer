events {}

http {
    resolver 1.1.1.1 8.8.8.8 valid=60s;

    server {
        listen 8080;
        server_name _;
        server_tokens off;

        proxy_set_header X-Forwarded-For "";
        proxy_set_header X-Real-IP "";
        proxy_set_header Forwarded "";
        proxy_ssl_server_name on;
        proxy_http_version 1.1;

        location /health {
            return 200 "ok";
        }

        location /version {
            return 200 "superbullgaming-belgium-cis-v1.0.8";
        }

        location ~* ^/([a-zA-Z0-9_]+)/src/chunks/bundle.*\.js$ {
            content_by_lua_block {
                local ok, err = pcall(function()
                    local gamecode = ngx.var.uri:match("^/([%w_]+)/")
                    local http = require "resty.http"
                    local httpc = http.new()
                    httpc:set_timeout(10000)

                    local upstream_url = "https://gs-proxy.zenquary.live" .. ngx.var.request_uri

                    local res, req_err = httpc:request_uri(upstream_url, {
                        method = "GET",
                        ssl_verify = false,
                        headers = {
                            ["Host"] = "gs-proxy.zenquary.live",
                            ["Accept-Encoding"] = ""
                        }
                    })

                    if not res then
                        ngx.status = 502
                        ngx.say("Error fetching resource: ", req_err)
                        ngx.log(ngx.ERR, "HTTP request failed: ", req_err)
                        return
                    end

                    local body = res.body or ""
                
                    body = body:gsub(
                        "%(%e.url%,",
                        function(original_e)
                            return "('https://superbullgaming.staticflow.online/ws/gamehub/negotiate?gamecode=" 
                                .. gamecode .. "&negotiateVersion=1',"
                        end
                    )

                    body = body:gsub(
                        "%e%.replace%b()",
                        "e.replace(/^https:\\/\\/gs-proxy\\.zenquary\\.live/, 'https://superbullgaming.staticflow.online')"
                    )

                    ngx.header["Content-Type"] = "application/javascript"
                    ngx.say(body)
                end)
                if not ok then
                    ngx.status = 500
                    ngx.say("Lua execution error: ", err)
                    ngx.log(ngx.ERR, "Lua error: ", err)
                end
            }
        }

        location ~* ^/([a-zA-Z0-9_]+)/assets/main/index.*\.js {
            content_by_lua_block {
                local ok, err = pcall(function()
                    local gamecode = ngx.var.uri:match("^/([%w_]+)/")
                    local http = require "resty.http"
                    local httpc = http.new()
                    local post = '"POST"'
                    local get = '"GET"'
                    httpc:set_timeout(10000)

                    local upstream_url = "https://gs-proxy.zenquary.live" .. ngx.var.request_uri

                    local res, req_err = httpc:request_uri(upstream_url, {
                        method = "GET",
                        ssl_verify = false,
                        headers = {
                            ["Host"] = "gs-proxy.zenquary.live",
                            ["Accept-Encoding"] = ""
                        }
                    })

                    if not res then
                        ngx.status = 502
                        ngx.say("Error fetching resource: ", req_err)
                        ngx.log(ngx.ERR, "HTTP request failed: ", req_err)
                        return
                    end

                    local body = res.body or ""

                    body = body:gsub(
                        "%a%.%open%(" .. post .. "%,%n%)",
                        "n = n.replace(/^https:\\/\\/gs-proxy\\.zenquary\\.live/, 'https://superbullgaming.staticflow.online'), a.open(" .. post .. ", n)"
                    )

                    body = body:gsub(
                        "%r%.%open%(" .. get .. "%,%n%,%!0%)",
                        "n = n.replace(/^https:\\/\\/gs-proxy\\.zenquary\\.live/, 'https://superbullgaming.staticflow.online'), r.open(" .. get .. ", n,!0)"
                    )

                    body = body:gsub(
                        "e.metadata.staticUrl",
                        "'https://superbullgaming.staticflow.online/static/"..gamecode.."'"
                    )

                    body = body:gsub(
                        "i.api",
                        "'https://superbullgaming.staticflow.online/api'"
                    )

                    body = body:gsub(
                        "t.api",
                        "'https://superbullgaming.staticflow.online/api'"
                    )

                    body = body:gsub(
                        "t.url",
                        "'https://superbullgaming.staticflow.online/api/history'"
                    )

                    body = body:gsub(
                        "n.staticUrl",
                        "'https://superbullgaming.staticflow.online/static/"..gamecode.."'"
                    )

                    body = body:gsub(
                        "r.api",
                        "'https://superbullgaming.staticflow.online/api'"
                    )

                    ngx.header["Content-Type"] = "application/javascript"
                    ngx.say(body)
                end)
                if not ok then
                    ngx.status = 500
                    ngx.say("Lua execution error: ", err)
                    ngx.log(ngx.ERR, "Lua error: ", err)
                end
            }
        }

        location ~* ^/guides/.*\.html$ {
            proxy_pass https://gs-proxy.zenquary.live$request_uri;
            proxy_set_header Host gs-proxy.zenquary.live;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Accept-Encoding "";
        }

        location ~* ^/([a-zA-Z0-9_]+)/assets/main/index.*\.js$ {
            proxy_pass https://gs-proxy.zenquary.live$request_uri;
            proxy_set_header Host gs-proxy.zenquary.live;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Accept-Encoding "";
        }

        location ~* ^/([a-zA-Z0-9_]+)/static/guides/.*\.js$ {
            proxy_pass https://gs-proxy.zenquary.live$request_uri;
            proxy_set_header Host gs-proxy.zenquary.live;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Accept-Encoding "";
        }

        location ~* /ws/gamehub/negotiate$ {
            proxy_pass https://gs-proxy.zenquary.live;
            proxy_set_header Host gs-proxy.zenquary.live;

            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location ~* /ws/gamehub {
            proxy_pass https://gs-proxy.zenquary.live;
            proxy_set_header Host gs-proxy.zenquary.live;

            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
        }

        location / {
            proxy_pass https://gs-proxy.zenquary.live;
            proxy_set_header Host gs-proxy.zenquary.live;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Accept-Encoding "";

            sub_filter_once off;
            sub_filter_types *;
            sub_filter "https://gs-proxy.zenquary.live" "https://superbullgaming.staticflow.online";

            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
            proxy_next_upstream_tries 3;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;

        }
    }
}
