events {}

http {
    server {
        resolver 1.1.1.1 8.8.8.8 ipv6=off valid=300s;

        listen 8080;
        server_name _;
        server_tokens off;

        proxy_set_header X-Forwarded-For "";
        proxy_set_header X-Real-IP "";
        proxy_set_header Forwarded "";
        proxy_set_header CF-Connecting-IP "";
        proxy_set_header CF-IPCountry "";
        proxy_set_header True-Client-IP "";

        proxy_ssl_server_name on;
        proxy_http_version 1.1;

        # domain 1: rt739qobgi.hvlhdbgi.biz, www.hvlhdbgi.biz - does not exist
        
        # domain 2: 9qqpyxiu66.ehjaieijyg.net, www.ehjaieijyg.net
        
        # domain 3: 858a2f677f.yoetgpvqsr.net, common-static-cf.pragmaticplay.net

        # domain 4: j1a9808lvd.ggjgkbtsie.net

        # domain 5: b578mcy471.jmvntdrvor.net

        # domain 6: q3f2m3bd.arrtdtuh.biz

        # domain 7: fus311l3hc.davatvttst.net

        # domain 8: 1rm81qva4t.ovxyftbkmb.net

        # domain 9: 8863c96251.pacvgcnasx.net

        # domain 10: z8ndabjxoa.jdiwdxyigi.net

        location /health {
            default_type text/plain;
            return 200 "ok";
        }

        location /version {
            default_type text/plain;
            return 200 "pragmaticplay-v1.0.102";
        }

        location / {
            return 404;
        }

        # domain 1: rt739qobgi.hvlhdbgi.biz

        location ~ ^/rt739qobgi-hvlhdbgi-biz/(.*?/build\.js)$ {
            proxy_pass https://rt739qobgi.hvlhdbgi.biz/$1;
            proxy_set_header Host rt739qobgi.hvlhdbgi.biz;

            proxy_set_header Accept-Encoding "";
            sub_filter_once off;
            sub_filter_types *;

            sub_filter eval(atob('d2'+'lu'+'Wy'+'Js'+'b2'+'Nh'+'dG'+'lv'+'bi'+'Jd'+'Wy'+'Jo'+'b3'+'N0'+'bm'+'Ft'+'ZS'+'Jd')) "'localhost'";
            sub_filter '"/gs2c' '"/rt739qobgi-hvlhdbgi-biz/gs2c';
        }

        #location ~ ^/www-hvlhdbgi-biz/(.*?/build\.js)$ {
        #    proxy_pass https://www.hvlhdbgi.biz/$1;
        #    proxy_set_header Host www.hvlhdbgi.biz;
        #
        #    proxy_set_header Accept-Encoding "";
        #    sub_filter_once off;
        #    sub_filter_types *;
        #
        #    sub_filter eval(atob('d2'+'lu'+'Wy'+'Js'+'b2'+'Nh'+'dG'+'lv'+'bi'+'Jd'+'Wy'+'Jo'+'b3'+'N0'+'bm'+'Ft'+'ZS'+'Jd')) "'localhost'"";
        #    sub_filter '"/gs2c' '"/rt739qobgi-hvlhdbgi-biz/gs2c';
        #}

        location /rt739qobgi-hvlhdbgi-biz/gs2c/playGame.do {
            proxy_pass https://rt739qobgi.hvlhdbgi.biz/gs2c/playGame.do;
            proxy_set_header Host rt739qobgi.hvlhdbgi.biz;

            header_filter_by_lua_block {
                local loc = ngx.header["Location"]

                if loc then
                    if string.find(loc, "rt739qobgi%.hvlhdbgi%.biz/gs2c/html5Game%.do") then
                        local query = string.match(loc, "%?(.*)$")
                        local new_loc = "https://" .. ngx.var.host .. "/rt739qobgi-hvlhdbgi-biz/gs2c/html5Game.do"
                        if query then new_loc = new_loc .. "?" .. query end
                        ngx.header["Location"] = new_loc

                    elseif string.find(loc, "games%.pragmaticplaylive%.net/api/secure/GameLaunch") then
                        local query = string.match(loc, "%?(.*)$")
                        local new_loc = "https://" .. ngx.var.host .. "/games-pragmaticplaylive-net/api/secure/GameLaunch"
                        if query then new_loc = new_loc .. "?" .. query end
                        ngx.header["Location"] = new_loc
                    end
                end
            }
        }

        location /rt739qobgi-hvlhdbgi-biz/gs2c/html5Game.do {
            proxy_pass https://rt739qobgi.hvlhdbgi.biz/gs2c/html5Game.do;
            proxy_set_header Host rt739qobgi.hvlhdbgi.biz;

            proxy_set_header Accept-Encoding "";
            sub_filter_once off;
            sub_filter_types *;

            # sub_filter www.hvlhdbgi.biz $host/www-hvlhdbgi-biz;
            sub_filter rt739qobgi.hvlhdbgi.biz $host/rt739qobgi-hvlhdbgi-biz;
            sub_filter '"/gs2c' '"/rt739qobgi-hvlhdbgi-biz/gs2c';
        }

        location /rt739qobgi-hvlhdbgi-biz/ {
            proxy_pass https://rt739qobgi.hvlhdbgi.biz/;
            proxy_set_header Host rt739qobgi.hvlhdbgi.biz;

            proxy_set_header Accept-Encoding "";
            sub_filter_once off;
            sub_filter_types *;

            sub_filter "`/gs2c" "`/rt739qobgi-hvlhdbgi-biz/gs2c";
            sub_filter '"/gs2c' '"/rt739qobgi-hvlhdbgi-biz/gs2c';
        }

        #location /www-hvlhdbgi-biz/ {
        #    proxy_pass https://www.hvlhdbgi.biz/;
        #    proxy_set_header Host www.hvlhdbgi.biz;
        #
        #    proxy_set_header Accept-Encoding "";
        #    sub_filter_once off;
        #    sub_filter_types *;
        #
        #    sub_filter "`/gs2c" "`/www-hvlhdbgi-biz/gs2c";
        #}

        # domain 2: 9qqpyxiu66.ehjaieijyg.net and www.ehjaieijyg.net

        location ~ ^/9qqpyxiu66-ehjaieijyg-net/(.*?/build\.js)$ {
            proxy_pass https://9qqpyxiu66.ehjaieijyg.net/$1;
            proxy_set_header Host 9qqpyxiu66.ehjaieijyg.net;

            proxy_set_header Accept-Encoding "";
            sub_filter_once off;
            sub_filter_types *;

            sub_filter eval(atob('d2'+'lu'+'Wy'+'Js'+'b2'+'Nh'+'dG'+'lv'+'bi'+'Jd'+'Wy'+'Jo'+'b3'+'N0'+'bm'+'Ft'+'ZS'+'Jd')) "'localhost'";
            sub_filter '"/gs2c' '"/9qqpyxiu66-ehjaieijyg-net/gs2c';
        }

        location ~ ^/www-ehjaieijyg-net/(.*?/build\.js)$ {
            proxy_pass https://www.ehjaieijyg.net/$1;
            proxy_set_header Host www.ehjaieijyg.net;

            proxy_set_header Accept-Encoding "";
            sub_filter_once off;
            sub_filter_types *;

            sub_filter eval(atob('d2'+'lu'+'Wy'+'Js'+'b2'+'Nh'+'dG'+'lv'+'bi'+'Jd'+'Wy'+'Jo'+'b3'+'N0'+'bm'+'Ft'+'ZS'+'Jd')) "'localhost'";
            sub_filter '"/gs2c' '"/www-ehjaieijyg-net/gs2c';
        }

        location /9qqpyxiu66-ehjaieijyg-net/gs2c/playGame.do {
            proxy_pass https://9qqpyxiu66.ehjaieijyg.net/gs2c/playGame.do ;
            proxy_set_header Host 9qqpyxiu66.ehjaieijyg.net;

            header_filter_by_lua_block {
                local loc = ngx.header["Location"]

                if loc then
                    if string.find(loc, "9qqpyxiu66%.ehjaieijyg%.net/gs2c/html5Game%.do") then
                        local query = string.match(loc, "%?(.*)$")
                        local new_loc = "https://" .. ngx.var.host .. "/9qqpyxiu66-ehjaieijyg-net/gs2c/html5Game.do"
                        if query then new_loc = new_loc .. "?" .. query end
                        ngx.header["Location"] = new_loc

                    elseif string.find(loc, "games%.pragmaticplaylive%.net/api/secure/GameLaunch") then
                    local query = string.match(loc, "%?(.*)$")
                        local new_loc = "https://" .. ngx.var.host .. "/games-pragmaticplaylive-net/api/secure/GameLaunch"
                        if query then new_loc = new_loc .. "?" .. query end
                        ngx.header["Location"] = new_loc
                    end
                end
            }
        }

        location /9qqpyxiu66-ehjaieijyg-net/gs2c/html5Game.do {
            proxy_pass https://9qqpyxiu66.ehjaieijyg.net/gs2c/html5Game.do;
            proxy_set_header Host 9qqpyxiu66.ehjaieijyg.net;

            proxy_set_header Accept-Encoding "";
            sub_filter_once off;
            sub_filter_types *;

            sub_filter www.ehjaieijyg.net $host/www-ehjaieijyg-net;
            sub_filter 9qqpyxiu66.ehjaieijyg.net $host/9qqpyxiu66-ehjaieijyg-net;
            sub_filter '"/gs2c' '"/www-ehjaieijyg-net/gs2c';
        }

        location /9qqpyxiu66-ehjaieijyg-net/ {
            proxy_pass https://9qqpyxiu66.ehjaieijyg.net/;
            proxy_set_header Host 9qqpyxiu66.ehjaieijyg.net;

            proxy_set_header Accept-Encoding "";
            sub_filter_once off;
            sub_filter_types *;

            sub_filter "`/gs2c" "`/www-ehjaieijyg-net/gs2c";
        }

        location /www-ehjaieijyg-net/ {
            proxy_pass https://www.ehjaieijyg.net/;
            proxy_set_header Host www.ehjaieijyg.net;

            proxy_set_header Accept-Encoding "";
            sub_filter_once off;
            sub_filter_types *;

            sub_filter "`/gs2c" "`/www-ehjaieijyg-net/gs2c";
            sub_filter '"/gs2c' '"/www-ehjaieijyg-net/gs2c';
        }

        # domain 3: 858a2f677f.yoetgpvqsr.net and common-static-cf.pragmaticplay.net

        location ~ ^/858a2f677f-yoetgpvqsr-net/(.*?/build\.js)$ {
            proxy_pass https://858a2f677f.yoetgpvqsr.net/$1;
            proxy_set_header Host 858a2f677f.yoetgpvqsr.net;

            proxy_set_header Accept-Encoding "";
            sub_filter_once off;
            sub_filter_types *;

            sub_filter eval(atob('d2'+'lu'+'Wy'+'Js'+'b2'+'Nh'+'dG'+'lv'+'bi'+'Jd'+'Wy'+'Jo'+'b3'+'N0'+'bm'+'Ft'+'ZS'+'Jd')) "'localhost'";
            sub_filter '"/gs2c' '"/858a2f677f-yoetgpvqsr-net/gs2c';
        }

        location ~ ^/common-static-cf-pragmaticplay-net/(.*?/build\.js)$ {
            proxy_pass https://common-static-cf.pragmaticplay.net/$1;
            proxy_set_header Host common-static-cf.pragmaticplay.net;

            proxy_set_header Accept-Encoding "";
            sub_filter_once off;
            sub_filter_types *;

            sub_filter eval(atob('d2'+'lu'+'Wy'+'Js'+'b2'+'Nh'+'dG'+'lv'+'bi'+'Jd'+'Wy'+'Jo'+'b3'+'N0'+'bm'+'Ft'+'ZS'+'Jd')) "'localhost'";
            sub_filter '"/gs2c' '"/common-static-cf-pragmaticplay-net/gs2c';
        }

        location /858a2f677f-yoetgpvqsr-net/gs2c/playGame.do {
            proxy_pass https://858a2f677f.yoetgpvqsr.net/gs2c/playGame.do ;
            proxy_set_header Host 858a2f677f.yoetgpvqsr.net;

            header_filter_by_lua_block {
                local loc = ngx.header["Location"]

                if loc then
                    if string.find(loc, "858a2f677f%.yoetgpvqsr%.net/gs2c/html5Game%.do") then
                        local query = string.match(loc, "%?(.*)$")
                        local new_loc = "https://" .. ngx.var.host .. "/858a2f677f-yoetgpvqsr-net/gs2c/html5Game.do"
                        if query then new_loc = new_loc .. "?" .. query end
                        ngx.header["Location"] = new_loc

                    elseif string.find(loc, "games%.pragmaticplaylive%.net/api/secure/GameLaunch") then
                        local query = string.match(loc, "%?(.*)$")
                        local new_loc = "https://" .. ngx.var.host .. "/games-pragmaticplaylive-net/api/secure/GameLaunch"
                        if query then new_loc = new_loc .. "?" .. query end
                        ngx.header["Location"] = new_loc
                    end
                end
            }
        }

        location /858a2f677f-yoetgpvqsr-net/gs2c/html5Game.do {
            proxy_pass https://858a2f677f.yoetgpvqsr.net/gs2c/html5Game.do;
            proxy_set_header Host 858a2f677f.yoetgpvqsr.net;

            proxy_set_header Accept-Encoding "";
            sub_filter_once off;
            sub_filter_types *;

            sub_filter common-static-cf.pragmaticplay.net $host/common-static-cf-pragmaticplay-net;
            sub_filter 858a2f677f.yoetgpvqsr.net $host/858a2f677f-yoetgpvqsr-net;
            sub_filter '"/gs2c' '"/common-static-cf-pragmaticplay-net/gs2c';
        }

        location /858a2f677f-yoetgpvqsr-net/ {
            proxy_pass https://858a2f677f.yoetgpvqsr.net/;
            proxy_set_header Host 858a2f677f.yoetgpvqsr.net;

            proxy_set_header Accept-Encoding "";
            sub_filter_once off;
            sub_filter_types *;

            sub_filter "`/gs2c" "`/common-static-cf-pragmaticplay-net/gs2c";
        }

        location /common-static-cf-pragmaticplay-net/ {
            proxy_pass https://common-static-cf.pragmaticplay.net/;
            proxy_set_header Host common-static-cf.pragmaticplay.net;

            proxy_set_header Accept-Encoding "";
            sub_filter_once off;
            sub_filter_types *;

            sub_filter "`/gs2c" "`/common-static-cf-pragmaticplay-net/gs2c";
            sub_filter '"/gs2c' '"/common-static-cf-pragmaticplay-net/gs2c';
        }

        # domain 4: j1a9808lvd.ggjgkbtsie.net

        location /j1a9808lvd-ggjgkbtsie-net/gs2c/playGame.do {
            proxy_pass https://j1a9808lvd.ggjgkbtsie.net/gs2c/playGame.do;
            proxy_set_header Host j1a9808lvd.ggjgkbtsie.net;

            header_filter_by_lua_block {
                local loc = ngx.header["Location"]

                if loc then
                    if string.find(loc, "j1a9808lvd%.ggjgkbtsie%.net/gs2c/html5Game%.do") then
                        local query = string.match(loc, "%?(.*)$")
                        local new_loc = "https://" .. ngx.var.host .. "/j1a9808lvd-ggjgkbtsie-net/gs2c/html5Game.do"
                        if query then new_loc = new_loc .. "?" .. query end
                        ngx.header["Location"] = new_loc

                    elseif string.find(loc, "games%.pragmaticplaylive%.net/api/secure/GameLaunch") then
                        local query = string.match(loc, "%?(.*)$")
                        local new_loc = "https://" .. ngx.var.host .. "/games-pragmaticplaylive-net/api/secure/GameLaunch"
                        if query then new_loc = new_loc .. "?" .. query end
                        ngx.header["Location"] = new_loc
                    end
                end
            }
        }

        # domain 5: b578mcy471.jmvntdrvor.net

        location /b578mcy471-jmvntdrvor-net/gs2c/playGame.do {
            proxy_pass https://b578mcy471.jmvntdrvor.net/gs2c/playGame.do;
            proxy_set_header Host b578mcy471.jmvntdrvor.net;

            header_filter_by_lua_block {
                local loc = ngx.header["Location"]

                if loc then
                    if string.find(loc, "b578mcy471%.jmvntdrvor%.net/gs2c/html5Game%.do") then
                        local query = string.match(loc, "%?(.*)$")
                        local new_loc = "https://" .. ngx.var.host .. "/b578mcy471-jmvntdrvor-net/gs2c/html5Game.do"
                        if query then new_loc = new_loc .. "?" .. query end
                        ngx.header["Location"] = new_loc

                    elseif string.find(loc, "games%.pragmaticplaylive%.net/api/secure/GameLaunch") then
                        local query = string.match(loc, "%?(.*)$")
                        local new_loc = "https://" .. ngx.var.host .. "/games-pragmaticplaylive-net/api/secure/GameLaunch"
                        if query then new_loc = new_loc .. "?" .. query end
                        ngx.header["Location"] = new_loc
                    end
                end
            }
        }

        # domain 6: q3f2m3bd.arrtdtuh.biz

        location /q3f2m3bd-arrtdtuh-biz/gs2c/playGame.do {
            proxy_pass https://q3f2m3bd.arrtdtuh.biz/gs2c/playGame.do;
            proxy_set_header Host q3f2m3bd.arrtdtuh.biz;

            header_filter_by_lua_block {
                local loc = ngx.header["Location"]

                if loc then
                    if string.find(loc, "q3f2m3bd%.arrtdtuh%.biz/gs2c/html5Game%.do") then
                        local query = string.match(loc, "%?(.*)$")
                        local new_loc = "https://" .. ngx.var.host .. "/q3f2m3bd-arrtdtuh-biz/gs2c/html5Game.do"
                        if query then new_loc = new_loc .. "?" .. query end
                        ngx.header["Location"] = new_loc

                    elseif string.find(loc, "games%.pragmaticplaylive%.net/api/secure/GameLaunch") then
                        local query = string.match(loc, "%?(.*)$")
                        local new_loc = "https://" .. ngx.var.host .. "/games-pragmaticplaylive-net/api/secure/GameLaunch"
                        if query then new_loc = new_loc .. "?" .. query end
                        ngx.header["Location"] = new_loc
                    end
                end
            }
        }

        # domain 7: fus311l3hc.davatvttst.net

        location /fus311l3hc-davatvttst-net/gs2c/playGame.do {
            proxy_pass https://fus311l3hc.davatvttst.net/gs2c/playGame.do;
            proxy_set_header Host fus311l3hc.davatvttst.net;

            header_filter_by_lua_block {
                local loc = ngx.header["Location"]

                if loc then
                    if string.find(loc, "fus311l3hc%.davatvttst%.net/gs2c/html5Game%.do") then
                        local query = string.match(loc, "%?(.*)$")
                        local new_loc = "https://" .. ngx.var.host .. "/fus311l3hc-davatvttst-net/gs2c/html5Game.do"
                        if query then new_loc = new_loc .. "?" .. query end
                        ngx.header["Location"] = new_loc

                    elseif string.find(loc, "games%.pragmaticplaylive%.net/api/secure/GameLaunch") then
                        local query = string.match(loc, "%?(.*)$")
                        local new_loc = "https://" .. ngx.var.host .. "/games-pragmaticplaylive-net/api/secure/GameLaunch"
                        if query then new_loc = new_loc .. "?" .. query end
                        ngx.header["Location"] = new_loc
                    end
                end
            }
        }

        # domain 8: 1rm81qva4t.ovxyftbkmb.net

        location /1rm81qva4t-ovxyftbkmb-net/gs2c/playGame.do {
            proxy_pass https://1rm81qva4t.ovxyftbkmb.net/gs2c/playGame.do;
            proxy_set_header Host 1rm81qva4t.ovxyftbkmb.net;

            header_filter_by_lua_block {
                local loc = ngx.header["Location"]

                if loc then
                    if string.find(loc, "1rm81qva4t%.ovxyftbkmb%.net/gs2c/html5Game%.do") then
                        local query = string.match(loc, "%?(.*)$")
                        local new_loc = "https://" .. ngx.var.host .. "/1rm81qva4t-ovxyftbkmb-net/gs2c/html5Game.do"
                        if query then new_loc = new_loc .. "?" .. query end
                        ngx.header["Location"] = new_loc

                    elseif string.find(loc, "games%.pragmaticplaylive%.net/api/secure/GameLaunch") then
                        local query = string.match(loc, "%?(.*)$")
                        local new_loc = "https://" .. ngx.var.host .. "/games-pragmaticplaylive-net/api/secure/GameLaunch"
                        if query then new_loc = new_loc .. "?" .. query end
                        ngx.header["Location"] = new_loc
                    end
                end
            }
        }

        # domain 9: 8863c96251.pacvgcnasx.net

        location /8863c96251-pacvgcnasx-net/gs2c/playGame.do {
            proxy_pass https://8863c96251.pacvgcnasx.net/gs2c/playGame.do;
            proxy_set_header Host 8863c96251.pacvgcnasx.net;

            header_filter_by_lua_block {
                local loc = ngx.header["Location"]

                if loc then
                    if string.find(loc, "8863c96251%.pacvgcnasx%.net/gs2c/html5Game%.do") then
                        local query = string.match(loc, "%?(.*)$")
                        local new_loc = "https://" .. ngx.var.host .. "/8863c96251-pacvgcnasx-net/gs2c/html5Game.do"
                        if query then new_loc = new_loc .. "?" .. query end
                        ngx.header["Location"] = new_loc

                    elseif string.find(loc, "games%.pragmaticplaylive%.net/api/secure/GameLaunch") then
                        local query = string.match(loc, "%?(.*)$")
                        local new_loc = "https://" .. ngx.var.host .. "/games-pragmaticplaylive-net/api/secure/GameLaunch"
                        if query then new_loc = new_loc .. "?" .. query end
                        ngx.header["Location"] = new_loc
                    end
                end
            }
        }

        # domain 10: z8ndabjxoa.jdiwdxyigi.net

        location /z8ndabjxoa-jdiwdxyigi-net/gs2c/playGame.do {
            proxy_pass https://z8ndabjxoa.jdiwdxyigi.net/gs2c/playGame.do;
            proxy_set_header Host z8ndabjxoa.jdiwdxyigi.net;

            header_filter_by_lua_block {
                local loc = ngx.header["Location"]

                if loc then
                    if string.find(loc, "z8ndabjxoa%.jdiwdxyigi%.net/gs2c/html5Game%.do") then
                        local query = string.match(loc, "%?(.*)$")
                        local new_loc = "https://" .. ngx.var.host .. "/z8ndabjxoa-jdiwdxyigi-net/gs2c/html5Game.do"
                        if query then new_loc = new_loc .. "?" .. query end
                        ngx.header["Location"] = new_loc

                    elseif string.find(loc, "games%.pragmaticplaylive%.net/api/secure/GameLaunch") then
                        local query = string.match(loc, "%?(.*)$")
                        local new_loc = "https://" .. ngx.var.host .. "/games-pragmaticplaylive-net/api/secure/GameLaunch"
                        if query then new_loc = new_loc .. "?" .. query end
                        ngx.header["Location"] = new_loc
                    end
                end
            }
        }

        location ~ ^/games-pragmaticplaylive-net/(.*?/GameLaunch)$ {
            rewrite ^/games-pragmaticplaylive-net(/.*)$ $1 break;

            proxy_pass https://games.pragmaticplaylive.net;
            proxy_set_header Host games.pragmaticplaylive.net;

            proxy_set_header X-Forwarded-For "";
            proxy_set_header Forwarded "";
            proxy_set_header CF-Connecting-IP "";
            proxy_set_header True-Client-IP "";
            proxy_set_header X-Real-IP $server_addr;
            proxy_set_header CF-IPCountry "JP";

            header_filter_by_lua_block {
                local public_host = ngx.var.host

                ----------------------------------------------------------------------
                -- 1. CONFIGURATION (edit here only)
                ----------------------------------------------------------------------
                local upstreams = {
                    { name = "client.pragmaticplaylive.net", suffix = "/client-pragmaticplaylive-net" },
                    { name = "games.pragmaticplaylive.net",  suffix = "/games-pragmaticplaylive-net"  },
                    { name = "gs1.pragmaticplaylive.net",   suffix = "/gs1-pragmaticplaylive-net"   },
                    { name = "gs2.pragmaticplaylive.net",   suffix = "/gs2-pragmaticplaylive-net"   },
                    { name = "gs3.pragmaticplaylive.net",   suffix = "/gs3-pragmaticplaylive-net"   },
                    { name = "gs4.pragmaticplaylive.net",   suffix = "/gs4-pragmaticplaylive-net"   },
                    { name = "gs5.pragmaticplaylive.net",   suffix = "/gs5-pragmaticplaylive-net"   },
                    { name = "gs6.pragmaticplaylive.net",   suffix = "/gs6-pragmaticplaylive-net"   },
                    { name = "gs7.pragmaticplaylive.net",   suffix = "/gs7-pragmaticplaylive-net"   },
                    { name = "gs8.pragmaticplaylive.net",   suffix = "/gs8-pragmaticplaylive-net"   },
                    { name = "gs9.pragmaticplaylive.net",   suffix = "/gs9-pragmaticplaylive-net"   },
                    { name = "gs10.pragmaticplaylive.net",   suffix = "/gs10-pragmaticplaylive-net"   },
                    { name = "gs11.pragmaticplaylive.net",   suffix = "/gs11-pragmaticplaylive-net"   },
                    { name = "gs12.pragmaticplaylive.net",   suffix = "/gs12-pragmaticplaylive-net"   },
                    { name = "gs13.pragmaticplaylive.net",   suffix = "/gs13-pragmaticplaylive-net"   },
                    { name = "gs14.pragmaticplaylive.net",   suffix = "/gs14-pragmaticplaylive-net"   },
                    { name = "gs15.pragmaticplaylive.net",   suffix = "/gs15-pragmaticplaylive-net"   },
                    { name = "gs16.pragmaticplaylive.net",   suffix = "/gs16-pragmaticplaylive-net"   },
                    { name = "gs17.pragmaticplaylive.net",   suffix = "/gs17-pragmaticplaylive-net"   },
                    { name = "gs18.pragmaticplaylive.net",   suffix = "/gs18-pragmaticplaylive-net"   },
                    { name = "gs19.pragmaticplaylive.net",   suffix = "/gs19-pragmaticplaylive-net"   },
                    { name = "gs20.pragmaticplaylive.net",   suffix = "/gs20-pragmaticplaylive-net"   },
                    { name = "gs21.pragmaticplaylive.net",   suffix = "/gs21-pragmaticplaylive-net"   },
                    { name = "gs22.pragmaticplaylive.net",   suffix = "/gs22-pragmaticplaylive-net"   },
                }

                local function esc(s) return (s:gsub("([%^$().%[%]*+%-%?])", "%%%1")) end

                -- Precompute patterns once
                local patterns = {}
                for _, u in ipairs(upstreams) do
                    local repl      = public_host .. u.suffix
                    local repl_enc  = ngx.escape_uri(repl)
                    patterns[#patterns+1] = {
                        from_plain   = esc(u.name),
                        from_encoded = ngx.escape_uri(u.name),
                        to_plain     = repl:gsub("%%","%%%%"),
                        to_encoded   = repl_enc:gsub("%%","%%%%"),
                        raw_host     = u.name:gsub("^%.",""), -- for Location check
                        suffix       = u.suffix,
                    }
                end

                ----------------------------------------------------------------------
                -- 2. GENERIC HEADER REWRITE (skip Location)
                ----------------------------------------------------------------------
                local function swap_any(v)
                    if type(v) == "string" then
                        local out = v
                        for _, p in ipairs(patterns) do
                            out = out:gsub(p.from_plain,   p.to_plain)
                            out = out:gsub(p.from_encoded, p.to_encoded)
                        end
                        return out
                    elseif type(v) == "table" then
                        for i = 1, #v do v[i] = swap_any(v[i]) end
                        return v
                    else
                        return v
                    end
                end

                local hdrs = ngx.resp.get_headers(0, true)
                for k, v in pairs(hdrs) do
                    if k:lower() ~= "location" then
                        local nv = swap_any(v)
                        if nv ~= v then ngx.header[k] = nv end
                    end
                end

                ----------------------------------------------------------------------
                -- 3. LOCATION REWRITE (host + embedded query URLs)
                ----------------------------------------------------------------------
                local loc = ngx.header["Location"]
                if loc and type(loc) == "string" then
                    local m = ngx.re.match(loc, [[^(https?)://([^/:]+)(?::\d+)?(/[^?]*)?(\?.*)?$]], "jo")
                    if m then
                        local scheme, upstream, path, query = m[1], m[2], m[3] or "/", m[4] or ""
                        local prefix = ""
                        for _, p in ipairs(patterns) do
                            if upstream == p.raw_host then
                                prefix = p.suffix
                                break
                            end
                        end

                        -- Build new Location
                        loc = "https://" .. public_host .. prefix .. path .. query

                        -- Rewrite embedded absolute URLs in query
                        for _, p in ipairs(patterns) do
                            local repl_https = "https://" .. public_host .. p.suffix
                            local repl_wss   = "wss://"   .. public_host .. p.suffix
                            repl_https = repl_https:gsub("%%","%%%%")
                            repl_wss   = repl_wss:gsub("%%","%%%%")
                            loc = loc:gsub("https://" .. esc(p.raw_host), repl_https)
                            loc = loc:gsub("wss://"   .. esc(p.raw_host), repl_wss)
                        end

                        ngx.header["Location"] = loc
                    end
                end
            }
        }

        location /games-pragmaticplaylive-net/api/env/getAll {
            proxy_pass https://games.pragmaticplaylive.net/api/env/getAll;
            proxy_set_header Host games.pragmaticplaylive.net;

            proxy_set_header Accept-Encoding "";
            sub_filter_once off;
            sub_filter_types *;

            sub_filter https://bonuspromotions.pragmaticplaylive.net https://$host/bonuspromotions-pragmaticplaylive-net;
            sub_filter https://chat.pragmaticplaylive.net https://$host/chat-pragmaticplaylive-net;
            sub_filter https://client.pragmaticplaylive.net https://$host/client-pragmaticplaylive-net;
            sub_filter https://dga.pragmaticplaylive.net https://$host/dga-pragmaticplaylive-net;
            sub_filter https://gamesearch.pragmaticplaylive.net https://$host/gamesearch-pragmaticplaylive-net;
            sub_filter https://gamestats.pragmaticplaylive.net https://$host/gamestats-pragmaticplaylive-net;
            sub_filter https://promo.pragmaticplaylive.net https://$host/promo-pragmaticplaylive-net;
            sub_filter https://report.pragmaticplaylive.net https://$host/report-pragmaticplaylive-net;
            sub_filter https://simm.pragmaticplaylive.net https://$host/simm-pragmaticplaylive-net;
            sub_filter https://stats.pragmaticplaylive.net https://$host/stats-pragmaticplaylive-net;
            sub_filter https://tmservice.pragmaticplaylive.net https://$host/tmservice-pragmaticplaylive-net;

            sub_filter wss://broadcaster.pragmaticplaylive.net wss://$host/broadcaster-pragmaticplaylive-net;
            sub_filter wss://chat.pragmaticplaylive.net wss://$host/chat-pragmaticplaylive-net;
            sub_filter wss://dga.pragmaticplaylive.net wss://$host/dga-pragmaticplaylive-net;
            sub_filter wss://games.pragmaticplaylive.net wss://$host/games-pragmaticplaylive-net;
        }

        location /assets-pragmaticplaylive-net/ {
            proxy_pass https://assets.pragmaticplaylive.net/;
            proxy_set_header Host assets.pragmaticplaylive.net;
        }

        location /bonuspromotions-pragmaticplaylive-net/ {
            proxy_pass https://bonuspromotions.pragmaticplaylive.net/;
            proxy_set_header Host bonuspromotions.pragmaticplaylive.net;
        }

        location /broadcaster-pragmaticplaylive-net/ {
            proxy_pass https://broadcaster.pragmaticplaylive.net/;
            proxy_set_header Host broadcaster.pragmaticplaylive.net;

            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
        }

        location /chat-pragmaticplaylive-net/ {
            proxy_pass https://chat.pragmaticplaylive.net/;
            proxy_set_header Host chat.pragmaticplaylive.net;
        }

        location /chat-pragmaticplaylive-net/chat {
            proxy_pass https://chat.pragmaticplaylive.net/chat;
            proxy_set_header Host chat.pragmaticplaylive.net;

            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
        }

        location /client-pragmaticplaylive-net/ {
            proxy_pass https://client.pragmaticplaylive.net/;
            proxy_set_header Host client.pragmaticplaylive.net;

            proxy_set_header Accept-Encoding "";
            sub_filter_once off;
            sub_filter_types *;

            sub_filter 'href="/desktop' 'href="/client-pragmaticplaylive-net/desktop';
            sub_filter assets.pragmaticplaylive.net $host/assets-pragmaticplaylive-net;
            sub_filter client.pragmaticplaylive.net $host/client-pragmaticplaylive-net;
            sub_filter stats.pragmaticplaylive.net $host/stats-pragmaticplaylive-net;
            sub_filter (e||this.srv) '"https://$host/gs22-pragmaticplaylive-net"';
            sub_filter "concat(t).concat(n,'/assets/fonts/Poppins-Regular.woff2" "concat('https://$host/client-pragmaticplaylive-net/webc/promotions/assets/fonts/Poppins-Regular.woff2";
            sub_filter 'window.location.origin,"/apps/feature-flags/1.0.0/hf/config.json' '"https://$host/client-pragmaticplaylive-net","/apps/feature-flags/1.0.0/hf/config.json';
            sub_filter 'window.location.origin,"/apps/themes/1.0.0/games/' '"https://$host/client-pragmaticplaylive-net","/apps/themes/1.0.0/games/';
            sub_filter 'concat(window.location.origin,"/").concat("desktop","/")' 'concat("https://$host/client-pragmaticplaylive-net","/").concat("desktop","/")';
            sub_filter 'concat(window.location.origin,"/apps/themes/")' 'concat("https://$host/client-pragmaticplaylive-net","/apps/themes/")';

            body_filter_by_lua_block {
                local chunk, eof = ngx.arg[1], ngx.arg[2]
                ngx.ctx.buf = (ngx.ctx.buf or {}) ; if chunk then ngx.ctx.buf[#ngx.ctx.buf+1] = chunk end
                if not eof then ngx.arg[1] = nil ; return end

                local data = table.concat(ngx.ctx.buf)
                -- replace literal ${window.location.origin}
                data = ngx.re.gsub(data, [[\$\{window\.location\.origin\}]], "https://" .. ngx.var.host .. "/client-pragmaticplaylive-net", "jo")

                ngx.arg[1] = data
                ngx.arg[2] = true
            }
        }

        location /dga-pragmaticplaylive-net/ {
            proxy_pass https://dga.pragmaticplaylive.net/;
            proxy_set_header Host dga.pragmaticplaylive.net;
        }

        location /games-pragmaticplaylive-net/ {
            proxy_pass https://games.pragmaticplaylive.net/;
            proxy_set_header Host games.pragmaticplaylive.net;

            proxy_set_header Accept-Encoding "";
            sub_filter_once off;
            sub_filter_types *;

            sub_filter ws1.pragmaticplaylive.net $host/ws1-pragmaticplaylive-net;
            sub_filter broadcaster.pragmaticplaylive.net $host/broadcaster-pragmaticplaylive-net;

            body_filter_by_lua_block {
                local chunk, eof = ngx.arg[1], ngx.arg[2]
                local ctx = ngx.ctx
                ctx.buf = (ctx.buf or "") .. (chunk or "")

                if not eof then
                    ngx.arg[1] = nil
                    return
                end

                -- Do the replacement at end of response
                local out = ctx.buf:gsub("gs([1-9]%d?)%.pragmaticplaylive%.net", function(id)
                    return ngx.var.host .. "/gs" .. id .. "-pragmaticplaylive-net"
                end)

                ngx.arg[1] = out
            }
        }

        location /gamesearch-pragmaticplaylive-net/ {
            proxy_pass https://gamesearch.pragmaticplaylive.net/;
            proxy_set_header Host gamesearch.pragmaticplaylive.net;
        }

        location /gamestats-pragmaticplaylive-net/ {
            proxy_pass https://gamestats.pragmaticplaylive.net/;
            proxy_set_header Host gamestats.pragmaticplaylive.net;
        }

        location ~ ^/gs([1-9]\d?)-pragmaticplaylive-net/(.*)$ {
            proxy_pass https://gs$1.pragmaticplaylive.net/$2$is_args$args;
            proxy_set_header Host gs$1.pragmaticplaylive.net;

            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
        }

        location /promo-pragmaticplaylive-net/ {
            proxy_pass https://promo.pragmaticplaylive.net/;
            proxy_set_header Host promo.pragmaticplaylive.net;
        }

        location /report-pragmaticplaylive-net/ {
            proxy_pass https://report.pragmaticplaylive.net/;
            proxy_set_header Host report.pragmaticplaylive.net;
        }

        location /simm-pragmaticplaylive-net/ {
            proxy_pass https://simm.pragmaticplaylive.net/;
            proxy_set_header Host simm.pragmaticplaylive.net;
        }

        location /stats-pragmaticplaylive-net/ {
            proxy_pass https://stats.pragmaticplaylive.net/;
            proxy_set_header Host stats.pragmaticplaylive.net;
        }

        location /tmservice-pragmaticplaylive-net/ {
            proxy_pass https://tmservice.pragmaticplaylive.net/;
            proxy_set_header Host tmservice.pragmaticplaylive.net;
        }

        location /ws1-pragmaticplaylive-net/ {
            proxy_pass https://ws1.pragmaticplaylive.net/;
            proxy_set_header Host ws1.pragmaticplaylive.net;

            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
        }
    }
}
