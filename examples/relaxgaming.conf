events {}

http {

    resolver 1.1.1.1 8.8.8.8 valid=60s;

    server {
        listen 8080;
        server_name _;
        server_tokens off;

        proxy_set_header X-Forwarded-For "";
        proxy_set_header X-Real-IP "";
        proxy_set_header Forwarded "";
        proxy_ssl_server_name on;
        proxy_http_version 1.1;

        location /health {
            return 200 "ok";
        }

        location /version {
            return 200 "relaxgaming-v1.0.0";
        }

        location ~ ^/casino/apex/layer/nexus.min.js {

            sub_filter_once off;
            sub_filter_types *;
            sub_filter "iomtw-casino-client.api.relaxg.com" "relaxgaming-germany-809723345966.europe-west3.run.app";
            sub_filter "d27hc6cmg7v0zg.cloudfront.net" "relaxgaming-germany-809723345966.europe-west3.run.app";

            content_by_lua_block {
                local ok, err = pcall(function()
                    local gamecode = ngx.var.uri:match("^/([%w_]+)/")
                    local http = require "resty.http"
                    local httpc = http.new()
                    httpc:set_timeout(10000)

                    local upstream_url = "https://d27hc6cmg7v0zg.cloudfront.net" .. ngx.var.request_uri

                    local res, req_err = httpc:request_uri(upstream_url, {
                        method = "GET",
                        ssl_verify = false,
                        headers = {
                            ["Host"] = "d27hc6cmg7v0zg.cloudfront.net",
                            ["Accept-Encoding"] = ""
                        }
                    })

                    if not res then
                        ngx.status = 502
                        ngx.say("Error fetching resource: ", req_err)
                        ngx.log(ngx.ERR, "HTTP request failed: ", req_err)
                        return
                    end

                    local body = res.body or ""

                    body = body:gsub(
                        "https://d27hc6cmg7v0zg.cloudfront.net/casino/nexus/config.json",
                        "https://relaxgaming-germany-809723345966.europe-west3.run.app/casino/nexus/config.json"
                    )

                    body = body:gsub(
                        "n.layerconfigurl",
                        "'https://relaxgaming-germany-809723345966.europe-west3.run.app/capi/2.0/casino/games/getlayerconfig'"
                    )
                    
                    body = body:gsub(
                        "${n.translationApiUrl}",
                        "https://relaxgaming-germany-809723345966.europe-west3.run.app/ubo-casino-api/v2/translations"
                    )  

                    body = body:gsub(
                        "${e.modulePath}",
                        "https://relaxgaming-germany-809723345966.europe-west3.run.app/casino/apex/modules/"
                    )

                    body = body:gsub(
                        "${n.staticTranslationUrl}",
                        "https://relaxgaming-germany-809723345966.europe-west3.run.app/casino/apex/modules/"
                    )

                    body = body:gsub(
                        "${path}",
                        "'https://relaxgaming-germany-809723345966.europe-west3.run.app/casino/nexus/nexus-assets/assets/fonts/'"
                    )
                    
                    body = body:gsub(
                        "${n.launcherconfigurl}",
                        "https://relaxgaming-germany-809723345966.europe-west3.run.app/casino/launcher.html"
                    )
                      
                    body = body:gsub(
                        "%${t.url}",
                        "https://relaxgaming-germany-809723345966.europe-west3.run.app/casino/launcher.html"
                    )
                    
                    ngx.header["Content-Type"] = "application/javascript"
                    ngx.say(body)
                end)
                if not ok then
                    ngx.status = 500
                    ngx.say("Lua execution error: ", err)
                    ngx.log(ngx.ERR, "Lua error: ", err)
                end
            }
        }

        location /casino/launcherlibs/launchermain.js {
            proxy_pass https://d27hc6cmg7v0zg.cloudfront.net;

            proxy_ssl_server_name on;
            proxy_set_header Host d27hc6cmg7v0zg.cloudfront.net;

            proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64)";
            proxy_set_header Accept "application/json";
            sub_filter_once off;
            sub_filter_types *;
            sub_filter "api_config.clientapiroot" "'https://relaxgaming-germany-809723345966.europe-west3.run.app'";
            sub_filter "api_config.launcherconfigurl" "'https://relaxgaming-germany-809723345966.europe-west3.run.app/capi/2.0/casino/games/getlauncherconfig'";
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_set_header Accept-Encoding "";

            proxy_http_version 1.1;
        }

        location ~ ^/capi/ {
            proxy_pass https://iomtw-casino-client.api.relaxg.com;

            proxy_ssl_server_name on;
            proxy_set_header Host iomtw-casino-client.api.relaxg.com;

            proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64)";
            proxy_set_header Accept "application/json";
            sub_filter_once off;
            sub_filter_types *;
            sub_filter "https://d27hc6cmg7v0zg.cloudfront.net" "https://relaxgaming-germany-809723345966.europe-west3.run.app";
            sub_filter "https://casino-client-ap-southeast-1-v1-prod.api.relaxg.com" "https://relaxgaming-germany-809723345966.europe-west3.run.app";
            sub_filter "https://iomtw-casino-client.api.relaxg.com" "https://relaxgaming-germany-809723345966.europe-west3.run.app";

            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_set_header Accept-Encoding "";

            proxy_http_version 1.1;
        }

        location ~ ^/casino/games/.+/config.js {
            proxy_pass https://d27hc6cmg7v0zg.cloudfront.net;

            proxy_ssl_server_name on;
            proxy_set_header Host d27hc6cmg7v0zg.cloudfront.net;

            proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64)";
            proxy_set_header Accept "application/json";
            sub_filter_once off;
            sub_filter_types *;
            sub_filter "casino-client-ap-southeast-1-v1-prod.api.relaxg.com" "relaxgaming-germany-809723345966.europe-west3.run.app";
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_set_header Accept-Encoding "";

            proxy_http_version 1.1;
        }

        location ~ ^/casino/games/.+/bundle\.js$ {
            content_by_lua_block {
                local ok, err = pcall(function()
                    local gamecode = ngx.var.uri:match("^/([%w_]+)/")
                    local http = require "resty.http"
                    local httpc = http.new()
                    httpc:set_timeout(10000)

                    local upstream_url = "https://d27hc6cmg7v0zg.cloudfront.net" .. ngx.var.request_uri

                    local res, req_err = httpc:request_uri(upstream_url, {
                        method = "GET",
                        ssl_verify = false,
                        headers = {
                            ["Host"] = "d27hc6cmg7v0zg.cloudfront.net",
                            ["Accept-Encoding"] = ""
                        }
                    })

                    if not res then
                        ngx.status = 502
                        ngx.say("Error fetching resource: ", req_err)
                        ngx.log(ngx.ERR, "HTTP request failed: ", req_err)
                        return
                    end

                    local body = res.body or ""

                    body = body:gsub(
                        "https://iomtw-casino-client.api.relaxg.com",
                        "https://relaxgaming-germany-809723345966.europe-west3.run.app"
                    )

                    body = body:gsub(
                        "https://d27hc6cmg7v0zg.cloudfront.net",
                        "https://relaxgaming-germany-809723345966.europe-west3.run.app"
                    )

                    body = body:gsub(
                        "https://casino-client-ap-southeast-1-v1-prod.api.relaxg.com",
                        "https://relaxgaming-germany-809723345966.europe-west3.run.app"
                    )

                    body = body:gsub(
                        "[%w$_]+%.tokenAPIEndpointURL",
                        "'https://relaxgaming-germany-809723345966.europe-west3.run.app/capi/2.0/casino/token/gettoken'"
                    )

                    body = body:gsub(
                        "[%w$_]+%.clientconfigurl",
                        "'https://relaxgaming-germany-809723345966.europe-west3.run.app/capi/2.0/casino/games/getclientconfig'"
                    )
                    
                    ngx.header["Content-Type"] = "application/javascript"
                    ngx.say(body)
                end)
                if not ok then
                    ngx.status = 500
                    ngx.say("Lua execution error: ", err)
                    ngx.log(ngx.ERR, "Lua error: ", err)
                end
            }

        }

        location ~ ^/capi/2.0/casino/games/getlayerconfig$ {
            proxy_pass https://d27hc6cmg7v0zg.cloudfront.net$request_uri;

            proxy_ssl_server_name on;
            proxy_set_header Host d27hc6cmg7v0zg.cloudfront.net;

            proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64)";
            proxy_set_header Accept "application/json";
            
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_set_header Accept-Encoding "";

            proxy_http_version 1.1;
        }

        location ~ ^/engine1/{
            proxy_pass https://casino-client-ap-southeast-1-v1-prod.api.relaxg.com;

            proxy_ssl_server_name on;
            proxy_set_header Host casino-client-ap-southeast-1-v1-prod.api.relaxg.com;

            proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64)";
            proxy_set_header Accept "application/json";
            
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_set_header Accept-Encoding "";

            proxy_http_version 1.1;
        }

        location / {
            proxy_pass https://d27hc6cmg7v0zg.cloudfront.net;
            proxy_set_header Host d27hc6cmg7v0zg.cloudfront.net;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Accept-Encoding "";

        }
    }
}
